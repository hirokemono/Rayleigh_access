\newpage
\section{Installation}


\subsection{Library Requirements}
\label{sec:requirements}
Calypso requires the following libraries.
\begin{itemize}
\item GNU make
\item MPI libraries (OpenMPI, MPICH, etc)
\end{itemize}
Linux and Max OS X use GNU make as a default 'make' command, but some system (e.g. BSD or SOLARIS) does not use GNU make as default. \verb|configure| command searches and set correct GNU make command.

\subsection{Known problems}
We have not found any problems with gfortran or Intel Fortran.

\subsubsection*{Cross compiler support}
{\tt configure} command in Rayleigh\_link does not support cross compilation. If you want to compile with a cross compiler, please set the variables in Makefile manually (see section \ref{section:no_configure})

\subsection{Directories}

The top directory of Calypso (ex. \verb|[CALYPSO_HOME]|) contains the following directories.
\begin{verbatim}
% cd [CALYPSO_HOME]
% ls
CMakeLists.txt	Makefile.in	configure.in	examples
INSTALL		bin		doc		src
LICENSE		configure	doxygen		work

\end{verbatim}

\begin{description}
\item{\verb bin:      } directory for executable files
\item{\verb doxygen:} directory for document generated by doxygen
\item{\verb doc:      } documentations
\item{\verb src:      } source files
\item{\verb tests: }     example for test
\item{\verb work:     } work directory. Compile is done in this directory.
\end{description}

\subsection{Doxygen}
Doxygen (\url{http://www.doxygen.org}) is an powerful document generation tool from source files. We only save a configuration file in this directory because thousands of html files generated by doxygen. The documents for source codes are generated by the following command:
% 
\begin{verbatim}
% cd [CALYPSO_HOME]/doxygen
% doxygen ./Doxyfile_CALYPSO
\end{verbatim}
%
The html documents can see by opening \verb|[CALYPSO_HOME]/doxygen/html/index.html|.  Automatically generated documentation is also available on the CIG website at \url{http://www.geodynamics.org/cig/software/calypso/}.

\subsection{Install using {\tt configure} command }
\subsubsection{Configuration using {\tt configure} command }
Calypso uses the configure script for configuration to install. The simplest way to install programs is the following process in the top directory of Calypso.
% 
\begin{verbatim}
%pwd
[CALYPSO_HOME]
% ./configure
...
% make
...
% make install
\end{verbatim}
%
After the installation, object modules can be deleted by the following command;
% 
\begin{verbatim}
% make clean
\end{verbatim}
%

{./configure} generates a Makefile in the current directory.  Available options for {\tt configure} can be checked using the {\tt ./configure --help} command. The following options are available in the {\tt configure} command.
%
{\small
\begin{verbatim}
Optional Features:
  --disable-option-checking  ignore unrecognized --enable/--with options
  --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
  --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
  --enable-fftw3          Use fftw3 library 
 Optional Packages:
  --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
  --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
  --with-hdf5=yes/no/PATH full path of h5pcc for parallel HDF5 configuration
  --with-blas=<lib>       use BLAS library <lib>
  --with-zlib=DIR root directory path of zlib installation defaults to
                    /usr/local or /usr if not found in /usr/local
  --without-zlib to disable zlib usage completely

Some influential environment variables:
  CC          C compiler command
  CFLAGS      C compiler flags
  LDFLAGS     linker flags, e.g. -L<lib dir> if you have libraries in a
              nonstandard directory <lib dir>
  LIBS        libraries to pass to the linker, e.g. -l<library>
  CPPFLAGS    (Objective) C/C++ preprocessor flags, e.g. -I<include dir> if
              you have headers in a nonstandard directory <include dir>
  FC          Fortran compiler command
  FCFLAGS     Fortran compiler flags
  MPICC       MPI C compiler command
  MPIFC       MPI Fortran compiler command
  PKG_CONFIG  path to pkg-config utility
  CPP         C preprocessor
  FFTW3_CFLAGS
              C compiler flags for FFTW3, overriding pkg-config
  FFTW3_LIBS  linker flags for FFTW3, overriding pkg-config

\end{verbatim}
}
%
An example of usage of the configure command is the following;
\begin{verbatim}
% ./configure --prefix='/Users/matsui/local' \
? CFLAGS='-O -Wall -g' FCFLAGS='-O -Wall -g' \
? PKG_CONFIG_PATH='/Users/matsui/local/lib/pkgconfig' \
? --with-blas=yes --enable-fftw3 --with-zlib=/usr/local \
? --with-hdf5='/Users/matsui/local/bin/h5pcc'

\end{verbatim}

\subsubsection{Compile}
Compile is performed using the {\tt make} command. The Makefile in the top directory is used to generate another Makefile in the {\tt work} directory, which is automatically used to complete the compilation. The object file and libraries are compiled in the {\tt work} directory. Finally, the executive files are assembled in {\tt bin} directory. You should find the following programs in the {\tt bin} directory.
%
\begin{description}
\item{\verb gen_sph_grids:    } Preprocessing program for data transfer for spherical transform
\item{\verb sph_mhd:          } Simulation program
\item{\verb sph_initial_field: } Example program to generate initial field
\item{\verb sph_add_initial_field: } Example program to add initial field in existing spectum data
\item{\verb sph_snapshot:     } Data transfer from spectrum data to field data
\item{\verb sph_dynamobench:  } Data processing for dynamo benchmark test by Christensen {\it et. al.} (2002)
\item{\verb sph_zm_snapshot:  } Generate zonal mean field
\item{\verb assemble_sph:     } Data transfer program to change number of subdomains.
\item{\verb t_ave_sph_mean_square:     } Time averaging program for the mean square data.
\item{\verb t_ave_picked_sph_coefs:     }  Time averaging program for the picked spectrum data.
\item{\verb t_ave_nusselt:     }                   Time averaging program for the Nusselt number data.
\item{\verb check_sph_grids:   }                   Check program for tests.
\item{\verb make_f90depends:  } Program to generate dependency of the source code ({\tt make} command uses to generate {\tt work/Makefile})
\end{description}
%
The following library files are also made in {\tt work} directory.
%
\begin{description}
\item{\verb libcalypso.a:    } Calypso library
\item{\verb libfftpack.5d.a: } FFTPACK 5.1 library
\end{description}
%

\subsubsection{Clean}
The object and fortran module files in {\tt work} directory is deleted by typing
\begin{verbatim}
% make clean
\end{verbatim}
This command deletes files with the extension {\tt .o}, {\tt .mod}, {\tt .par}, {\tt .diag}, and {\tt ~}.

\subsubsection{Distclean}
To revert the files and directory to the original package, use make distclean as
\begin{verbatim}
% make distclean
\end{verbatim}


\subsubsection{Install}
 The executive files are copied to the install directory \verb|$(INSTDIR)/bin|. The install directory \verb|$(INSTDIR)| is defined in Makefile, and can also set by  \verb|${--prefix}| option for \verb|configure| command. Alternatively, you can use the programs in \verb|${SRCDIR}/bin| directory without running \verb|make install|. If directory \verb|${PREFIX}| does not exist, \verb|make install | creates  \verb|${PREFIX}|,  \verb|${PREFIX}/lib|,  \verb|${PREFIX}/bin|, and  \verb|${PREFIX}/include| directories. No files are installed in \verb|${PREFIX}/lib| and \verb|${PREFIX}/include|.

\subsection{Install without using configure}
\label{section:no_configure}
It is possible to compile Calypso without using the \verb|configure| command. To do this, you need to edit the \verb|Makefile|. First, copy \verb|Makefile| from template \verb|Makefile.in| as
%
\begin{verbatim}
% cp Makefile.in Makefile
\end{verbatim}
In Makefile, the following variables should be defined.
%
\begin{description}
\item{\verb|SHELL|}    Name of shell command.
\item{\verb|SRCDIR|}   Directory of this Makefile. 
\item{\verb|INSTDIR|}  Install directory.
\item{\verb|MPICHDIR|} Directory names for MPI implementation. If you set fortran90 compiler name for MPI programs in \verb|MPIF90|, you do not need to define this valuable.
\item{\verb|MPICHINCDIR|} Directory names for include files for MPI implementation. If you set fortran90 compiler name for MPI programs in \verb|MPIF90|, you do not need to define this valuable.
\item{\verb|MPILIBS|}   Library names for MPI implementation. If you set fortran90 compiler name for MPI programs in \verb|MPIF90|, you do not need to define this valuable.
\item{\verb|F90_LOCAL|} Command name of local Fortran 90 compiler to compile module dependency listing program.
\item{\verb|MPIF90|} Command name of Fortran90 compiler and linker for MPI programs. If command does not have MPI implementation, you need to define the definition of MPI libraries \verb|MPICHDIR|, \verb|MPICHINCDIR|, and \verb|MPILIBS|.
\item{\verb|AR|}     Command name for archive program (ex. \verb|ar|) to generate libraries. If you need some options for archive command, options are also included in this valuable.
\item{\verb|RANLIB|} Command name for \verb|ranlib| to generate index to the contents of an archive. If system does not have \verb|ranlib|, set \verb|true| in this valuable. \verb|true| command does not do anything for libraries.
\item{}
\item{\verb|F90OPTFLAGS|}  Optimization flags for Fortran90 compiler (including OpenMP flags)
\item{\verb|BLAS_LIBS|} Library lists for BLAS  (ex.  \verb|-lblas|)
\item{\verb|ZLIB_CFLAGS|} Option flags for FFTW3  (ex.  \verb|-I/usr/include|)
\item{\verb|ZLIB_LIB|}   Library lists for FFTW3 (ex. \verb|-L/usr/lib -lz|)
\item{\verb|FFTW3_CFLAGS|} Option flags for FFTW3  (ex.  \verb|-I/usr/local/include|)
\item{\verb|FFTW3_LIBS|}   Library lists for FFTW3 (ex. \verb|-L/usr/local/lib -lfftw3 -lm|)
\item{\verb|HDF5_FFLAGS|}  Option flags to compile with HDF5. This setting can be found by using hfd5 command \verb|h5pfc -show|.

\item{\verb|HDF5_LDFLAGS|}    Option flags  to link with  HDF5. This setting can be found by using hfd5 command \verb|h5pfc -show|.

\item{\verb|HDF5_FLIBS|}   Library lists for HDF5. This setting can be found by using hfd5 command \verb|h5pfc -show|.

\end{description}
%
After running \verb|make| command, execute files are built in \verb|[CALYPSO_HOME]/work/bin| directory.
